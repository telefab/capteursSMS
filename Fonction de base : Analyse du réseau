#include <SoftwareSerial.h>
#include <Time.h>
#define TEMPS_ATTENTE_VEILLE 20 // Temps d'attente en secondes entre vérifications du réseau

SoftwareSerial GPRS (7, 8); // GPRS : relatif au shield GPRS ; Serial : relatif à l'ordinateur
boolean veille = true;
time_t tempsPrecedentVeille;

void switchGSMModule()
{
  digitalWrite(onModulePin,HIGH);
  delay(2100);
  digitalWrite(onModulePin,LOW);
}

void setup()
{
  GPRS.begin(19200); // Fréquence du module
  Serial.begin(19200);
  pinMode(ledGSM, OUTPUT);
  pinMode(onModulePin, OUTPUT);
  switchGSMModule();                              // switches the GSM module ON
  delay(500);
  GPRS.print("AT+CPIN=\"0000\"\r\n");           // Entrer le code PIN
  delay(20000);                               // Attente de l'établissement du réseau
  
  tempsPrecedentVeille = now();
}

void loop()
{
  time_t time = now();
  if ((time-tempsPrecedentVeille) >= TEMPS_ATTENTE_VEILLE)
  {
    reseauIndisponible(); // Vérification du réseau
    tempsPrecedentVeille = time;
  }
}

void reseauIndisponible() // Gère le réseau mobile
{  
  GPRS.print("AT+CREG?\r\n"); // Demande de l'enregistrement sur le réseau
  while (!GPRS.available());
  for (int i=0; i<21; i++) {
  GPRS.read(); }
  
  veille = GPRS.read() != 49 and GPRS.read() != 49; // Analyse du résultat
  
  if (veille) {
    Serial.println("*** Reseau indisponible, en veille ***");
  }
   else {
    Serial.println("*** Reseau fonctionnel, en fonctionnement normal ***");
  }
}
